name: 'Simple TestPyPI Cleanup'

on:
  schedule:
    # Run on the 1st of every month at 2:00 AM UTC
    - cron: '0 2 1 * *'
  workflow_dispatch:
    inputs:
      package_name:
        description: 'Package name'
        required: true
        default: 'supy'
      keep_recent_only:
        description: 'Keep only the most recent version'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Query only (no deletion)'
        required: false
        type: boolean
        default: true

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Set up Python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: 'Install pypi-cleanup'
        run: pip install pypi-cleanup
      
      - name: 'Run cleanup'
        run: |
          PACKAGE="${{ github.event.inputs.package_name || 'supy' }}"
          
          if [[ "${{ github.event.inputs.keep_recent_only }}" == "true" ]]; then
            echo "üßπ Cleaning all but most recent version of $PACKAGE"
            FLAGS="--leave-most-recent-only"
          else
            echo "üßπ Cleaning dev versions of $PACKAGE"
            FLAGS="-r .*\.dev[0-9]+$"
          fi
          
          if [[ "${{ github.event.inputs.dry_run || 'true' }}" == "true" ]]; then
            echo "üîç Running in query-only mode..."
            pypi-cleanup -u __token__ \
                         -p "$PACKAGE" \
                         -t https://test.pypi.org/ \
                         $FLAGS \
                         --query-only
          else
            echo "‚ö†Ô∏è  Running actual deletion..."
            pypi-cleanup -u __token__ \
                         -p "$PACKAGE" \
                         -t https://test.pypi.org/ \
                         $FLAGS \
                         --do-it \
                         --yes
          fi
        env:
          PYPI_CLEANUP_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}